name: Build and Deploy Phigros Assets

# 触发方式：
# 1. workflow_dispatch: 允许你在 GitHub 网页上手动点击运行，输入下载链接
# 2. repository_dispatch: 允许你的 Worker 通过 API 远程触发
on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'APK Download URL (Direct Link)'
        required: true
        type: string
      version_name:
        description: 'Version Name (Optional, manual trigger only)'
        required: false
        type: string
      version_code:
        description: 'Version Code (Optional, manual trigger only)'
        required: false
        type: string
  repository_dispatch:
    types: [new_phigros_version]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # 设置超时防止卡死，解包大文件通常耗时，给足 60 分钟
    timeout-minutes: 60
    
    permissions:
      contents: read
      deployments: write

    steps:
      # 1. 检出代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. 安装系统级依赖
      # aria2: 下载神器
      # libvorbis/ogg: fsb5 音频解码需要
      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 libvorbis-dev libogg-dev

      # 3. 配置 Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 4. 安装 Python 库
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4.5 安装 .NET 10（PhiInfo.CLI 运行时）
      - name: Set up .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          include-prerelease: true

      # 5. 运行主脚本 (核心逻辑)
      - name: Run Build Script (Main)
        env:
          # 自动判断来源：如果是手动触发取 inputs，如果是 API 触发取 payload
          APK_DOWNLOAD_URL: ${{ inputs.apk_url || github.event.client_payload.download_url }}
          # 先跳过 main.py 内部索引生成，待 PhiInfo 与版本文件落盘后再统一生成
          SKIP_INDEX_GENERATION: "1"
        run: |
          python main.py

      # 5.5 运行 PhiInfo
      - name: Run PhiInfo Extraction
        run: |
          dotnet PhiInfo.CLI/PhiInfo.CLI.dll game.apk false
          
          # 将 PhiInfo 生成的 all_info.json 移动到 output/info
          mkdir -p output/info
          mv output/all_info.json output/info/ 2>/dev/null || true

      # 5.6 生成版本文件，供前端/客户端读取
      - name: Generate Version File
        env:
          # 优先手动输入，其次使用 Worker repository_dispatch 的 payload
          VERSION_NAME: ${{ inputs.version_name || github.event.client_payload.version_name }}
          VERSION_CODE: ${{ inputs.version_code || github.event.client_payload.version_code }}
          APK_DOWNLOAD_URL: ${{ inputs.apk_url || github.event.client_payload.download_url }}
        run: |
          mkdir -p output/info

          if [ -n "${VERSION_NAME:-}" ] && [ -n "${VERSION_CODE:-}" ]; then
            VERSION_TEXT="${VERSION_NAME} (${VERSION_CODE})"
          elif [ -n "${VERSION_NAME:-}" ]; then
            VERSION_TEXT="${VERSION_NAME}"
          elif [ -n "${VERSION_CODE:-}" ]; then
            VERSION_TEXT="${VERSION_CODE}"
          else
            # 手动触发未提供版本时，尝试从 APK URL 中提取 x.y.z / x.y 版本号，失败则写 unknown
            VERSION_TEXT="$(printf '%s\n' "${APK_DOWNLOAD_URL:-}" | sed -nE 's/.*([0-9]+\.[0-9]+(\.[0-9]+)?).*/\1/p' | head -n 1)"
            if [ -z "${VERSION_TEXT:-}" ]; then
              VERSION_TEXT="unknown"
            fi
          fi

          printf '%s\n' "${VERSION_TEXT}" > output/info/version.txt
          echo "Generated output/info/version.txt => ${VERSION_TEXT}"

      # 5.7 最终生成索引（包含 PhiInfo 与 version.txt）
      - name: Generate Final Index
        run: |
          python -c "import generate_index; generate_index.generate_site_resources()"

      # 6. 部署到 Cloudflare Pages
      # 直接上传 output 文件夹
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./output --project-name=somnia-asset --commit-dirty=true
