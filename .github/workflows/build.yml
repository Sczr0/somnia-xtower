name: Build and Deploy Phigros Assets

# 触发方式：
# 1. workflow_dispatch: 允许你在 GitHub 网页上手动点击运行，输入下载链接
# 2. repository_dispatch: 允许你的 Worker 通过 API 远程触发
on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'APK Download URL (Direct Link)'
        required: true
        type: string
  repository_dispatch:
    types: [new_phigros_version]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # 设置超时防止卡死，解包大文件通常耗时，给足 60 分钟
    timeout-minutes: 60
    
    permissions:
      contents: read
      deployments: write

    steps:
      # 1. 检出代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. 清理磁盘空间
      - name: Free Disk Space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "After cleanup:"
          df -h

      # 3. 安装系统级依赖
      # aria2: 下载神器
      # libvorbis/ogg: fsb5 音频解码需要
      - name: Install System Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 libvorbis-dev libogg-dev

      # 4. 配置 Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # 5. 安装 Python 库
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6. 运行主脚本 (核心逻辑)
      - name: Run Build Script (Main)
        env:
          # 自动判断来源：如果是手动触发取 inputs，如果是 API 触发取 payload
          APK_DOWNLOAD_URL: ${{ inputs.apk_url || github.event.client_payload.download_url }}
        run: |
          python main.py

      - name: List Output Directory for Debugging
        if: always() # 无论前面是否成功，都运行这一步
        run: |
          echo "--- Listing contents of the output directory ---"
          ls -R ./output

      # 7. 部署到 Cloudflare Pages
      # 直接上传 output 文件夹
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy ./output --project-name=somnia-asset --commit-dirty=true