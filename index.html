<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <meta name="theme-color" content="#fcfcfc" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#111111" media="(prefers-color-scheme: dark)">
  <meta name="description" content="Somnia Xtower Resource Index">
  <title>Somnia | Xtower</title>
  
  <link rel="stylesheet" href="Source%20Han%20Serif%20CN%20Light/result.css">
  <link rel="preload" href="files.json" as="fetch">

  <style>
    :root {
      --bg-color: #fcfcfc;
      --text-main: #222;
      --text-sub: #555;
      --accent: #10b981;
      --error: #ef4444;
      --safe-area-bottom: env(safe-area-inset-bottom);
      --card-bg-fallback: #ffffff; 
      --card-bg-glass: rgba(255, 255, 255, 0.75);
      --card-border: rgba(0, 0, 0, 0.08);
      --input-focus-bg: #fff;
      --selection-bg: rgba(16, 185, 129, 0.08);
      --shadow-sm: 0 4px 12px rgba(0,0,0,0.03);
      --shadow-lg: 0 15px 40px rgba(0,0,0,0.08);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #111;
        --text-main: #f0f0f0;
        --text-sub: #a0a0a0;
        --card-bg-fallback: #1e1e1e;
        --card-bg-glass: rgba(30, 30, 30, 0.75);
        --card-border: rgba(255, 255, 255, 0.1);
        --input-focus-bg: #1c1c1c;
        --selection-bg: rgba(16, 185, 129, 0.15);
        --shadow-sm: 0 4px 12px rgba(0,0,0,0.2);
        --shadow-lg: 0 15px 40px rgba(0,0,0,0.3);
      }
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0; padding: 0;
      background-color: var(--bg-color);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      -webkit-font-smoothing: antialiased;
      height: 100dvh;
      overflow: hidden;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: background-color 0.5s;
    }

    main {
      width: 100%; display: flex; flex-direction: column; align-items: center;
      position: relative; z-index: 10; 
      padding-bottom: 8vh;
    }

    /* --- 标题区域 --- */
    .center-content {
      text-align: center;
      font-family: "Source Han Serif CN Light", "Noto Serif SC", serif;
      font-size: clamp(0.9rem, 3.8vw, 1.8rem);
      font-weight: 300;
      letter-spacing: 0.1em;
      color: var(--text-main);
      display: flex; flex-direction: column; gap: 1.0rem;
      margin-bottom: 3.5rem;
      width: 100%;
      padding: 0 16px; 
      transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .text-line {
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      text-wrap: balance; 
      /* 防止中文标点在行首 */
      line-break: strict;
      word-break: keep-all; 
    }
    .text-line:nth-child(2) { animation-delay: 0.15s; }

    .quote-mark { opacity: 0.3; margin: 0 0.2em; font-family: sans-serif; }

    /* --- 搜索组件 --- */
    .search-container {
      position: relative;
      width: 88%; /* 稍微收窄一点 */
      max-width: 500px;
      opacity: 0;
      animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) 0.3s forwards;
    }

    .search-line {
      position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
      width: 1px; height: 50px;
      background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.15) 30%, rgba(0, 0, 0, 0.15) 70%, transparent 100%);
      opacity: 0.4;
      transition: all 0.5s ease;
      transform-origin: bottom;
    }

    .input-wrapper {
      position: relative;
      width: 100%;
    }

    #search-input {
      width: 100%;
      /* 窄屏下 Padding 保持紧凑 */
      padding: 12px 34px; 
      font-size: 16px; 
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0;
      box-shadow: none;
      color: var(--text-main);
      outline: none;
      text-align: center;
      font-family: "Source Han Serif CN Light", "Noto Serif SC", serif;
      letter-spacing: 0.05em;
      transition: border-color 0.3s, transform 0.3s;
      /* 防止输入内容太长溢出 */
      text-overflow: ellipsis;
    }

    @media (min-width: 768px) {
      #search-input { 
        font-size: 1.1rem; 
        padding: 12px 50px; 
      }
    }

    #search-input::placeholder {
      color: var(--text-sub);
      opacity: 0.6;
      transition: opacity 0.3s;
    }
    
    #search-input:focus {
      background: transparent;
      border-bottom-color: var(--accent);
      transform: translateY(-2px);
      padding-left: 0;
      text-align: left;
    }
    #search-input:focus::placeholder { opacity: 0; }
    
    #search-input.error {
      color: #ef4444;
      border-bottom-color: rgba(239, 68, 68, 0.3);
    }

    .clear-btn {
      position: absolute; right: 0; top: 50%; transform: translateY(-50%);
      width: 36px; height: 36px;
      background: transparent;
      border: 0;
      padding: 0;
      appearance: none;
      -webkit-appearance: none;
      mask: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E") no-repeat center / 18px 18px;
      -webkit-mask: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E") no-repeat center / 18px 18px;
      background-color: var(--text-sub);
      cursor: pointer; opacity: 0; pointer-events: none;
      transition: opacity 0.2s, background-color 0.2s;
    }
    .clear-btn.visible { opacity: 0.6; pointer-events: auto; }
    .clear-btn:hover { opacity: 1; background-color: var(--accent); }
    .clear-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 3px; border-radius: 999px; }

    .loader {
      position: absolute; right: 8px; top: 50%; margin-top: -9px;
      width: 18px; height: 18px;
      border: 2px solid var(--card-border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }
    .loader.active { display: block; }

    body.searching .center-content {
      opacity: 0.1; filter: blur(6px);
      transform: scale(0.98) translateY(-20px);
    }
    body.searching .search-line { transform: scaleY(0); opacity: 0; }

    #search-results {
      position: absolute; top: 100%; left: 0; width: 100%;
      margin-top: 10px;
      max-height: 0;
      overflow-y: hidden;
      background: var(--card-bg-fallback); 
      border-radius: 16px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 20;
    }

    @supports (backdrop-filter: blur(25px)) or (-webkit-backdrop-filter: blur(25px)) {
      #search-results {
        background: var(--card-bg-glass);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
      }
    }

    #search-results.show {
      max-height: var(--results-max-height, 55vh);
      opacity: 1;
      overflow-y: auto;
      transform: translateY(0);
      padding: 8px 0;
    }

    #search-results.open-up {
      top: auto;
      bottom: 100%;
      margin-top: 0;
      margin-bottom: 10px;
    }

    .result-item {
      display: block; padding: 12px 24px;
      color: var(--text-sub);
      text-decoration: none; font-size: 0.95rem;
      border-left: 3px solid transparent;
      cursor: pointer;
      position: relative;
      word-break: break-all;
    }

    .result-item:hover, .result-item[aria-selected="true"] {
      background: var(--selection-bg);
      color: var(--text-main);
      border-left-color: var(--accent);
    }

    .highlight { color: var(--accent); font-weight: 600; background: rgba(16, 185, 129, 0.08); padding: 0 2px; border-radius: 2px; }

    .footer-info {
      position: fixed; 
      bottom: 0; 
      padding-bottom: calc(25px + env(safe-area-inset-bottom));
      width: 100%;
      display: flex; justify-content: space-between; padding-left: 8vw; padding-right: 8vw;
      font-size: 0.75rem; color: var(--text-sub); opacity: 0.6;
      font-family: monospace; letter-spacing: 0.05em;
      animation: fadeInUp 1s ease-out 0.8s forwards; pointer-events: none;
      mix-blend-mode: difference;
    }

    @media (max-height: 500px) {
      .footer-info { display: none; }
    }

    .status-dot {
      display: inline-block; width: 8px; height: 8px; background: var(--accent);
      border-radius: 50%; margin-right: 8px;
      box-shadow: 0 0 10px var(--accent);
    }
    .status-dot.error { background: var(--error); box-shadow: 0 0 10px var(--error); }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }
  </style>
  <script defer src="https://umami.xtower.site/script.js" data-website-id="3fce56dc-4d07-471e-a5c7-0351f274575f"></script>
</head>
<body>

  <main>
    <div class="center-content">
      <div class="text-line"><span class="quote-mark">「</span>蝴蝶不会只在一朵花上倾注余生<span class="quote-mark">」</span></div>
      <div class="text-line"><span class="quote-mark">「</span>人却会一意孤行<span class="quote-mark">」</span></div>
    </div>

    <div class="search-container">
      <div class="search-line"></div>
      <div class="input-wrapper">
        <input type="search" id="search-input" placeholder="Initializing..." disabled aria-label="Search resources" role="combobox" aria-expanded="false" aria-autocomplete="list" aria-controls="search-results" autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false" inputmode="search" enterkeyhint="search">
        <div class="loader" id="loader"></div>
        <button class="clear-btn" id="clear-btn" type="button" aria-label="Clear search"></button>
      </div>
      <div id="search-results" role="listbox"></div>
    </div>
  </main>

  <footer class="footer-info">
    <div id="sys-status"><span class="status-dot"></span><span id="status-text">CONNECTING</span></div>
    <div>v1.4.2</div>
  </footer>

  <script>
    const UI = {
      body: document.body,
      input: document.getElementById('search-input'),
      results: document.getElementById('search-results'),
      clearBtn: document.getElementById('clear-btn'),
      loader: document.getElementById('loader'),
      statusDot: document.querySelector('.status-dot'),
      statusText: document.getElementById('status-text')
    };

    const State = {
      files: [],
      filesLower: [],
      selectedIndex: -1,
      isLoading: true
    };

    function getViewportHeight() {
      return window.visualViewport ? window.visualViewport.height : window.innerHeight;
    }

    function positionResults() {
      if (!UI.results.classList.contains('show')) return;

      const inputRect = UI.input.getBoundingClientRect();
      const viewportHeight = getViewportHeight();
      const gap = 10;
      const minHeight = 120;
      const preferredMax = Math.floor(viewportHeight * 0.55);
      const safeBottom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safe-area-bottom')) || 0;

      const spaceBelow = Math.max(0, viewportHeight - inputRect.bottom - gap - safeBottom);
      UI.results.classList.remove('open-up');

      const available = Math.floor(spaceBelow);
      const maxHeight = available < minHeight ? available : Math.min(preferredMax, available);
      document.documentElement.style.setProperty('--results-max-height', `${Math.max(0, maxHeight)}px`);
    }

    let positionRaf = 0;
    function schedulePositionResults() {
      if (positionRaf) return;
      positionRaf = requestAnimationFrame(() => {
        positionRaf = 0;
        positionResults();
      });
    }

    async function initSystem() {
      try {
        UI.loader.classList.add('active');
        const response = await fetch('files.json'); 
        if (!response.ok) throw new Error("HTTP " + response.status);
        
        const files = await response.json();
        State.files = Array.isArray(files) ? files.filter(f => typeof f === 'string') : [];
        State.filesLower = State.files.map(f => f.toLowerCase());
        
        State.isLoading = false;
        UI.input.disabled = false;
        UI.input.placeholder = "Search resources...";
        UI.statusText.textContent = "OPERATIONAL";
        UI.loader.classList.remove('active');
        
        if (window.matchMedia("(min-width: 768px)").matches) {
          UI.input.focus();
        }

      } catch (e) {
        console.error("System Failure:", e);
        UI.input.placeholder = "信号丢失";
        UI.input.classList.add('error');
        UI.statusDot.classList.add('error');
        UI.statusText.textContent = "OFFLINE";
        UI.loader.classList.remove('active');
        UI.input.disabled = false;
      }
    }

    function filterData(query) {
      if (!query) return [];
      const terms = query.toLowerCase().split(/\s+/).filter(t => t.length > 0);
      
      const results = [];
      for (let i = 0; i < State.files.length && results.length < 20; i++) {
        const fLower = State.filesLower[i];
        if (terms.every(term => fLower.includes(term))) {
          results.push(State.files[i]);
        }
      }
      return results;
    }

    function toSafeHref(path) {
      return path.split('/').map(segment => encodeURIComponent(segment)).join('/');
    }

    function appendHighlightedText(container, text, regex) {
      regex.lastIndex = 0;
      let lastIndex = 0;
      let match;

      while ((match = regex.exec(text)) !== null) {
        if (match.index > lastIndex) {
          container.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
        }

        const span = document.createElement('span');
        span.className = 'highlight';
        span.textContent = match[0];
        container.appendChild(span);

        lastIndex = match.index + match[0].length;
      }

      if (lastIndex < text.length) {
        container.appendChild(document.createTextNode(text.slice(lastIndex)));
      }
    }

    function renderResults(matches, query) {
      UI.results.innerHTML = '';
      State.selectedIndex = -1;
      UI.input.removeAttribute('aria-activedescendant');

      if (matches.length === 0) {
        if (query) {
          const div = document.createElement('div');
          div.className = 'result-item';
          div.style.textAlign = 'center';
          div.style.fontStyle = 'italic';
          div.textContent = 'No echoes found.';
          UI.results.appendChild(div);
          UI.results.classList.add('show');
          UI.input.setAttribute('aria-expanded', 'true');
          schedulePositionResults();
        } else {
          UI.results.classList.remove('show');
          UI.results.classList.remove('open-up');
          UI.input.setAttribute('aria-expanded', 'false');
        }
        return;
      }

      const fragment = document.createDocumentFragment();
      matches.forEach((file, index) => {
        const a = document.createElement('a');
        a.href = toSafeHref(file);
        a.className = 'result-item';
        a.role = 'option';
        a.id = `result-${index}`;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        
        const terms = query.split(/\s+/).filter(t => t.length > 0);
        if (terms.length > 0) {
          const escapedTerms = terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
          const regex = new RegExp(`(${escapedTerms.join('|')})`, 'gi');
          appendHighlightedText(a, file, regex);
        } else {
          a.textContent = file;
        }
        
        fragment.appendChild(a);
      });

      UI.results.appendChild(fragment);
      UI.results.classList.add('show');
      UI.input.setAttribute('aria-expanded', 'true');
      schedulePositionResults();
    }

    let inputDebounceTimer = 0;
    function onInputValueChanged(rawValue) {
      const val = rawValue.trim();
      UI.clearBtn.classList.toggle('visible', val.length > 0);
      UI.body.classList.toggle('searching', val.length > 0);
      renderResults(filterData(val), val);
    }
    UI.input.addEventListener('input', (e) => {
      const value = e.target.value;
      window.clearTimeout(inputDebounceTimer);
      inputDebounceTimer = window.setTimeout(() => onInputValueChanged(value), 40);
    });

    UI.input.addEventListener('focus', () => {
      if (UI.input.value.trim()) {
        onInputValueChanged(UI.input.value);
      }
    });

    UI.input.addEventListener('blur', () => {
      setTimeout(() => {
        const active = document.activeElement;
        const keepSearching = active === UI.input || active === UI.clearBtn || UI.results.contains(active);
        if (!keepSearching) UI.body.classList.remove('searching');
      }, 200);
    });
    
    document.addEventListener('click', (e) => {
      if (!UI.input.contains(e.target) && !UI.results.contains(e.target)) {
        UI.results.classList.remove('show');
        UI.results.classList.remove('open-up');
        UI.body.classList.remove('searching');
        UI.input.setAttribute('aria-expanded', 'false');
      }
    });

    UI.clearBtn.addEventListener('click', () => {
      UI.input.value = '';
      UI.input.focus();
      UI.results.classList.remove('show');
      UI.results.classList.remove('open-up');
      UI.clearBtn.classList.remove('visible');
      UI.body.classList.remove('searching');
      UI.input.setAttribute('aria-expanded', 'false');
    });

    UI.input.addEventListener('keydown', (e) => {
      const items = UI.results.querySelectorAll('a.result-item');
      if (!items.length) return;

      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (e.key === 'ArrowDown') {
          State.selectedIndex = (State.selectedIndex + 1) % items.length;
        } else {
          State.selectedIndex = (State.selectedIndex - 1 + items.length) % items.length;
        }
        items.forEach(i => i.setAttribute('aria-selected', 'false'));
        const activeItem = items[State.selectedIndex];
        activeItem.setAttribute('aria-selected', 'true');
        activeItem.scrollIntoView({ block: 'nearest' });
        UI.input.setAttribute('aria-activedescendant', activeItem.id);
      } 
      else if (e.key === 'Enter') {
        if (State.selectedIndex > -1) {
          items[State.selectedIndex].click();
        }
      }
      else if (e.key === 'Escape') {
        UI.input.blur();
        UI.results.classList.remove('show');
        UI.results.classList.remove('open-up');
        UI.body.classList.remove('searching');
        UI.input.setAttribute('aria-expanded', 'false');
      }
    });

    window.addEventListener('resize', schedulePositionResults);
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', schedulePositionResults);
      window.visualViewport.addEventListener('scroll', schedulePositionResults);
    }

    initSystem();
  </script>
</body>
</html>
